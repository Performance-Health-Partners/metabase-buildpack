#!/bin/sh

set -eu

METABASE_DIR="$1/target/uberjar"
METABASE_JAR="$METABASE_DIR/metabase.jar"
METABASE_URL="https://downloads.metabase.com/enterprise/v1.54.6/metabase.jar"


BUIILDPACK_BIN="$PWD/bin"
APP_BIN="$1/bin"
BACKUP_SCRIPT="pg_backup_to_s3"
DEBUG_LOG_FILE="debug-log4j2.xml"
DISCARD_FIELD_VALUES_SCRIPT="discard_field_values"

echo "Copying pg_backup_to_s3 to $APP_BIN"
cp "$BUIILDPACK_BIN/$BACKUP_SCRIPT" "$APP_BIN/$BACKUP_SCRIPT"
chmod +x "$APP_BIN/$BACKUP_SCRIPT"

echo "Copying debug-log4j2.xml to $APP_BIN"
cp "$BUIILDPACK_BIN/$DEBUG_LOG_FILE" "$APP_BIN/$DEBUG_LOG_FILE"
chmod +x "$APP_BIN/$DEBUG_LOG_FILE"

echo "Copying $DISCARD_FIELD_VALUES_SCRIPT to $APP_BIN"
cp "$BUIILDPACK_BIN/$DISCARD_FIELD_VALUES_SCRIPT" "$APP_BIN/$DISCARD_FIELD_VALUES_SCRIPT"
chmod +x "$APP_BIN/$DISCARD_FIELD_VALUES_SCRIPT"

mkdir -p $METABASE_DIR

echo -n "-----> Downloading Metabase... from $METABASE_URL to $METABASE_JAR"
curl -s --retry 3 -o $METABASE_JAR -L $METABASE_URL
echo "done"
